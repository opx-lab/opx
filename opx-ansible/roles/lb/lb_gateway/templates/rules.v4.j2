*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# --- INPUT (lb-vm itself) ---
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT

# SSH to lb-vm (from opx-pc)
-A INPUT -i eth0 -p tcp --dport 22 -s 192.168.1.50/32 -j ACCEPT

# DNS service for mgmt subnet (dnsmasq on lb-vm)
-A INPUT -i eth1 -p udp --dport 53 -s 192.168.55.0/24 -j ACCEPT
-A INPUT -i eth1 -p tcp --dport 53 -s 192.168.55.0/24 -j ACCEPT

# node_exporter on lb-vm (scraped from mgmt subnet)
-A INPUT -i eth1 -p tcp --dport 9100 -s 192.168.55.0/24 -j ACCEPT


# --- FORWARD (routing) ---
-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# east-west inside mgmt subnet
-A FORWARD -i eth1 -o eth1 -s 192.168.55.0/24 -d 192.168.55.0/24 -j ACCEPT

# VMs -> opx-pc apt-cacher-ng
-A FORWARD -i eth1 -o eth0 -s 192.168.55.0/24 -d 192.168.1.50/32 -p tcp --dport 3142 -j ACCEPT

# opx-pc -> mgmt subnet SSH (lets you run Ansible from opx-pc without ProxyJump)
-A FORWARD -i eth0 -o eth1 -s 192.168.1.50/32 -d 192.168.55.0/24 -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# Internet egress (what we achieved: mgmt-vm + docker-vm)
-A FORWARD -i eth1 -o eth0 -s 192.168.55.10/32 -j ACCEPT
-A FORWARD -i eth1 -o eth0 -s 192.168.55.30/32 -j ACCEPT

COMMIT


*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# NAT for mgmt-vm + docker-vm
-A POSTROUTING -o eth0 -s 192.168.55.10/32 -j MASQUERADE
-A POSTROUTING -o eth0 -s 192.168.55.30/32 -j MASQUERADE

COMMIT

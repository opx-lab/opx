---
- name: Install Prometheus (Debian package)
  become: true
  ansible.builtin.apt:
    name: prometheus
    state: present
    update_cache: true

- name: Ensure Prometheus rules dir exists
  become: true
  ansible.builtin.file:
    path: /etc/prometheus/rules
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure file_sd directory exists
  become: true
  ansible.builtin.file:
    path: /etc/prometheus/file_sd
    state: directory
    owner: prometheus
    group: prometheus
    mode: "0755"

- name: Deploy node_exporter file_sd targets
  become: true
  ansible.builtin.template:
    src: targets/node_exporter.json.j2
    dest: /etc/prometheus/file_sd/node_exporter.json
    owner: prometheus
    group: prometheus
    mode: "0644"
  notify: restart_prometheus

- name: Deploy postgres_exporter file_sd targets
  ansible.builtin.template:
    src: targets/postgres_exporter.json.j2
    dest: /etc/prometheus/file_sd/postgres_exporter.json
    owner: prometheus
    group: prometheus
    mode: "0644"
  notify: restart_prometheus

- name: Deploy Prometheus config (authoritative)
  become: true
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    owner: root
    group: root
    mode: "0644"
    validate: "promtool check config %s"
  notify: restart_prometheus
  
- name: Validate Prometheus config (fail hard if broken)
  ansible.builtin.command: promtool check config /etc/prometheus/prometheus.yml
  changed_when: false

- name: Configure Prometheus retention + listen address (Debian default file)
  become: true
  ansible.builtin.copy:
    dest: /etc/default/prometheus
    owner: root
    group: root
    mode: "0644"
    content: |
      ARGS="--config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus --storage.tsdb.retention.time=15d --web.listen-address=0.0.0.0:9090"
  notify: restart_prometheus

- name: Gather service facts
  become: true
  ansible.builtin.service_facts:

- name: Pick Prometheus systemd unit (Debian variants)
  ansible.builtin.set_fact:
    prometheus_unit: >-
      {{
        (
          ['prometheus.service', 'prometheus']
          | select('in', (ansible_facts.services.keys() | list))
          | list
          | first
        ) | default('', true)
      }}

- name: Fail if Prometheus unit not found
  ansible.builtin.fail:
    msg: "Prometheus installed but no prometheus unit found in systemd. Known units: {{ ansible_facts.services.keys() | list | sort }}"
  when: prometheus_unit | length == 0

- name: Ensure Prometheus enabled and started
  become: true
  ansible.builtin.systemd:
    name: "{{ prometheus_unit }}"
    enabled: true
    state: started
    daemon_reload: true

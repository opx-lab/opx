---
- name: Install chrony
  ansible.builtin.apt:
    name: chrony
    state: present
    update_cache: false

- name: Configure chrony client (lb uses opx-pc, others use lb)
  ansible.builtin.copy:
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      {% if 'lb' in group_names %}
      server {{ chrony_upstream_lb }} iburst
      {% else %}
      server {{ chrony_upstream_vm }} iburst
      {% endif %}
      makestep 1.0 3
      rtcsync

- name: Ensure chrony is enabled and started
  ansible.builtin.systemd:
    name: chrony
    enabled: true
    state: started

- name: Wait for chrony sync
  ansible.builtin.command: chronyc tracking
  register: _chrony_tracking
  retries: 20
  delay: 3
  until:
    - _chrony_tracking.stdout is search("Leap status")
    - _chrony_tracking.stdout is search("Normal")
  changed_when: false

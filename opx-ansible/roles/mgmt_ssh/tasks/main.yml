---
- name: Set mgmt ssh user
  ansible.builtin.set_fact:
    mgmt_ssh_user: "opx"

- name: Ensure ~/.ssh exists on mgmt-vm
  ansible.builtin.file:
    path: "/home/{{ mgmt_ssh_user }}/.ssh"
    state: directory
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "0700"
  become: true

- name: Install mgmt private key on mgmt-vm (from repo artifacts)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../artifacts/ssh/mgmt_ed25519"
    dest: "/home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519"
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "0600"
  become: true

- name: Install mgmt public key on mgmt-vm (from repo artifacts)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../artifacts/ssh/mgmt_ed25519.pub"
    dest: "/home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519.pub"
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "0644"
  become: true

- name: Write SSH client config on mgmt-vm
  ansible.builtin.copy:
    dest: "/home/{{ mgmt_ssh_user }}/.ssh/config"
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "0600"
    content: |
      Host db-vm docker-vm monitor-vm 192.168.55.*
        User {{ mgmt_ssh_user }}
        IdentityFile /home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519
        IdentitiesOnly yes
        StrictHostKeyChecking accept-new
  become: true

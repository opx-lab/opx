- name: Set mgmt ssh user
  ansible.builtin.set_fact:
    mgmt_ssh_user: "opx"

- name: Ensure ~/.ssh exists on mgmt-vm
  ansible.builtin.file:
    path: "/home/{{ mgmt_ssh_user }}/.ssh"
    state: directory
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "0700"
  become: true

- name: Generate mgmt SSH keypair if missing (run as opx)
  ansible.builtin.command: >
    ssh-keygen -t ed25519 -a 64
    -f /home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519
    -N '' -C {{ mgmt_ssh_user }}@mgmt-vm
  args:
    creates: "/home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519"
  become: true
  become_user: "{{ mgmt_ssh_user }}"

# Safety net: if you ever generated as root, fix it every run (idempotent)
- name: Ensure correct ownership/perms of mgmt keypair
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "/home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519",     mode: "0600" }
    - { path: "/home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519.pub", mode: "0644" }
  become: true

- name: Read mgmt public key
  ansible.builtin.slurp:
    src: "/home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519.pub"
  register: mgmt_pubkey_slurp
  become: true
  become_user: "{{ mgmt_ssh_user }}"

- name: Set mgmt public key fact (as text)
  ansible.builtin.set_fact:
    mgmt_pubkey: "{{ mgmt_pubkey_slurp.content | b64decode | trim }}"

- name: Write SSH client config on mgmt-vm (use mgmt key for mgmt subnet)
  ansible.builtin.copy:
    dest: "/home/{{ mgmt_ssh_user }}/.ssh/config"
    owner: "{{ mgmt_ssh_user }}"
    group: "{{ mgmt_ssh_user }}"
    mode: "0600"
    content: |
      Host db-vm docker-vm monitor-vm 192.168.55.*
      User {{ mgmt_ssh_user }}
      IdentityFile /home/{{ mgmt_ssh_user }}/.ssh/mgmt_ed25519
      IdentitiesOnly yes
      StrictHostKeyChecking accept-new
  become: true

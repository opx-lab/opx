- name: Create registry directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /opt/stacks
    - /opt/stacks/registry
    - /opt/stacks/registry/data
  become: true

- name: Deploy registry compose file
  ansible.builtin.copy:
    dest: /opt/stacks/registry/compose.yml
    mode: "0644"
    content: |
      services:
        registry:
          image: registry:2
          container_name: registry
          restart: unless-stopped
          ports:
            - "5000:5000"
          volumes:
            - /opt/stacks/registry/data:/var/lib/registry
  become: true

- name: Registry | Ensure registry stack is running
  ansible.builtin.command:
    cmd: docker compose -f /opt/stacks/registry/compose.yml up -d
  args:
    chdir: /opt/stacks/registry
  register: registry_up
  changed_when: >
    'Creating' in registry_up.stdout
    or 'Recreating' in registry_up.stdout
    or 'Starting' in registry_up.stdout
  failed_when: false
  become: true
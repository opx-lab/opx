---
# roles/mgmt/tasks/10_tools.yml

# -------------------------
# APT baseline prereqs
# -------------------------
- name: Ensure APT keyrings dir exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure base packages for downloads exist
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - tar
    state: present
    update_cache: true

# -------------------------
# Terraform (HashiCorp repo) - key is vendored in roles/mgmt/files/hashicorp.gpg
# -------------------------
- name: Install HashiCorp keyring (vendored)
  ansible.builtin.copy:
    src: hashicorp.gpg
    dest: /etc/apt/keyrings/hashicorp.gpg
    owner: root
    group: root
    mode: "0644"

- name: Add HashiCorp APT repo
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/hashicorp.list
    owner: root
    group: root
    mode: "0644"
    content: |
      deb [signed-by=/etc/apt/keyrings/hashicorp.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main

- name: apt update (hashicorp)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 0
  register: _apt_upd_hashi
  retries: 5
  delay: 5
  until: _apt_upd_hashi is succeeded

- name: Install Terraform
  ansible.builtin.apt:
    name: terraform
    state: present

# -------------------------
# kubectl (Debian package)
# -------------------------
- name: Install kubectl (kubernetes-client)
  ansible.builtin.apt:
    name: kubernetes-client
    state: present

# -------------------------
# Helm (GitHub release binary) - avoids baltocdn repo + keyring + proxy CONNECT issues
# -------------------------
- name: Set Helm facts
  ansible.builtin.set_fact:
    helm_version: "v3.14.4"
    helm_arch: >-
      {{ 'amd64' if ansible_architecture in ['x86_64','amd64']
         else 'arm64' if ansible_architecture in ['aarch64','arm64']
         else ansible_architecture }}

- name: Download Helm tarball
  ansible.builtin.get_url:
    url: "https://get.helm.sh/helm-{{ helm_version }}-linux-{{ helm_arch }}.tar.gz"
    dest: "/tmp/helm-{{ helm_version }}-linux-{{ helm_arch }}.tar.gz"
    mode: "0644"
  register: _helm_dl
  retries: 10
  delay: 3
  until: _helm_dl is succeeded

- name: Extract Helm to /tmp (idempotent)
  ansible.builtin.unarchive:
    src: "/tmp/helm-{{ helm_version }}-linux-{{ helm_arch }}.tar.gz"
    dest: /tmp
    remote_src: true
    creates: "/tmp/linux-{{ helm_arch }}/helm"

- name: Install helm binary
  ansible.builtin.copy:
    src: "/tmp/linux-{{ helm_arch }}/helm"
    dest: /usr/local/bin/helm
    remote_src: true
    owner: root
    group: root
    mode: "0755"

- name: Cleanup Helm temp dir (only when Helm extracted)
  ansible.builtin.file:
    path: /tmp/linux-amd64
    state: absent
  when: (_helm_unarchive is defined) and (_helm_unarchive.changed | default(false))
  
# k9s (GitHub release binary)
# -------------------------
- name: Set k9s facts
  ansible.builtin.set_fact:
    k9s_version: "v0.32.7"
    k9s_arch: >-
      {{ 'amd64' if ansible_architecture in ['x86_64','amd64']
         else 'arm64' if ansible_architecture in ['aarch64','arm64']
         else ansible_architecture }}

- name: Download k9s tarball
  ansible.builtin.get_url:
    url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_Linux_{{ k9s_arch }}.tar.gz"
    dest: "/tmp/k9s_{{ k9s_version }}_Linux_{{ k9s_arch }}.tar.gz"
    mode: "0644"
  register: _k9s_dl
  retries: 10
  delay: 3
  until: _k9s_dl is succeeded

- name: Extract k9s to /usr/local/bin
  ansible.builtin.unarchive:
    src: "/tmp/k9s_{{ k9s_version }}_Linux_{{ k9s_arch }}.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/k9s

- name: Ensure k9s is executable
  ansible.builtin.file:
    path: /usr/local/bin/k9s
    mode: "0755"
